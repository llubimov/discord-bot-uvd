# Бот УВД

Discord-бот для кадрового учёта и заявок на сервере: заявки (курсант, перевод, гос), переводы между отделами, увольнения, повышения, склад. Всё настраивается через `.env`.

## Что делает

**Заявки** — в канале кнопки «Курсант», «Перевод», «Гос. сотрудник». По нажатию открывается форма, заявка уходит в канал, сотрудники с нужной ролью принимают/отклоняют/редактируют. При принятии выдаются роли из конфига, меняется ник. Курсанту после принятия в ЛС уходит приказ и кнопка в канал экзамена.

**Переводы между отделами (ГРОМ, ППС, ОСБ, ОРЛС)** — в своих каналах кнопки «Подать заявку из [отдела]». Заявка согласуется: сначала источник (если не из Академии), потом целевой отдел. При одобрении снимаются роли отделов и рангов, выдаётся роль отдела и одна должность (стажёр/сотрудник). Из Академии в ППС — без кнопок; в остальные отделы — кнопка одобрения или отказ.

**Админ-перевод в ППС** — скрытый канал с кнопками ГРОМ/ОСБ/ОРЛС. Начальник вводит ID и причину, у участника снимаются роли отделов и рангов, выдаётся ППС и базовая должность. Запись об переводе пишется в канал из `CHANNEL_ADMIN_TRANSFER`.

**Увольнение** — канал с кнопкой «Подать заявление». В канал рапортов уходит оформленный embed: шапка «РАПОРТ НА УВОЛЬНЕНИЕ», в теле строка вида `ОТ [звание в родительном падеже] — id [discord_id]`, ФИО, причина и флаг «с/без возможности восстановления». Есть авто‑рапорт при выходе с сервера. Сотрудники с `FIRING_STAFF_ROLE_ID` одобряют или отклоняют: при одобрении снимаются роли (кроме перечисленных в `KEEP_ON_FIRE_*`), выдаётся роль уволенного, ник меняется на «Уволен | Имя Фамилия».

**Повышения** — рапорты приходят вебхуком (Google Form) или создаются вручную. В каналах повышений у сообщения кнопки «Одобрить» / «Отклонить». Сообщения «Подать рапорт» (селектор повышения + форма) создаются при старте бота (`PROMOTION_AUTO_SEND_ON_STARTUP=1` в .env) или командами `/promotion_setup_all`, `/orls_promotion_setup`, `/osb_promotion_setup`, `/grom_promotion_setup`, `/pps_promotion_setup` в нужном канале. Эти сообщения держатся внизу канала при новых сообщениях. При одобрении снимаются старые звания, выдаётся новая роль по маппингу. Аудит (принят/повышен/уволен) только в Google Form по `AUDIT_FORM_URL`.

**Склад** — канал заявок на выдачу. Сотрудники принимают/отклоняют/редактируют состав заявки: можно открыть корзину, поменять количество предметов или удалить позиции, с проверкой лимитов по предметам и категориям. При выдаче пишется запись в канал аудита склада. Есть кулдаун между заявками (`WAREHOUSE_COOLDOWN_HOURS`).

**Аудит** — события (принят, повышен, уволен) только в Google Form. В канал админ-перевода пишутся только админ-переводы.

## Как устроено

Роли staff задаются в `.env` (кто жмёт принять/отклонить по типам заявок). Роли начальников/замов — кто одобряет переводы и админ-перевод. При переводе всегда снимаются все роли отделов и все ранги, выдаётся только роль отдела и одна базовая должность. Вебхуки (например из Google Form) обрабатываются отдельно: по `WEBHOOK_ALLOWED_IDS` и `WEBHOOK_ALLOWED_CHANNEL_IDS`. После перезапуска бота кнопки под сообщениями восстанавливаются из БД. БД — SQLite по умолчанию (`DATABASE_URL`).

Для часто используемых каналов и ролей используется внутренний кэш (`ChannelCache` / `RoleCache` в `state`), чтобы минимизировать количество повторных `get_channel` / `get_role` и ускорить ответы на нажатия кнопок.

## Производительность

- **Один сервер, до ~5–10k человек.** Бот рассчитан на один основной сервер, шардирование не требуется.
- **Кэш каналов/ролей.** Все горячие места (склад, увольнения, заявки, диагностика, фоновые позиции) сначала читают канал/роль из кэша, и только если там пусто — из Discord‑клиента.
- **Интервалы фоновых задач.** Позиционные менеджеры (шапки каналов) используют разные `check_interval`: склад и старт‑канал проверяются чаще, шапки переводов/академии — реже, чтобы не спамить `history.fetch`.
- **Кэш сообщений Discord.** В `Config.BOT_MAX_MESSAGES` (и `.env` через `BOT_MAX_MESSAGES`) можно управлять размером внутреннего кэша сообщений клиента. По умолчанию стоит более низкое значение, чем в чистом discord.py, чтобы экономить память.
- **Интенты.** Через `ENABLE_MESSAGE_CONTENT_INTENT` в `.env` можно выключить `message_content`‑intent, если в проде используются только слэш‑команды и кнопки — это уменьшает поток событий от Discord.

## Запуск

Скопируй `.env.example` в `.env`, заполни токен, ID сервера, каналов и ролей. Потом:

```bash
pip install -r requirements.txt
python main.py
```

В `.env` переменные разбиты по блокам с подписями.

## Слэш-команды

Доступны только пользователям с ролью выше роли бота: `/ping`, `/diag`, `/diag_clean_orphans`, `/clear_firing`, `/promotion_setup_all`, `/orls_promotion_setup`, `/osb_promotion_setup`, `/grom_promotion_setup`, `/pps_promotion_setup`. Про текущие глюки с частью команд см. `STATUS.md`.
