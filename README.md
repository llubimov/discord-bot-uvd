# Бот УВД

Discord-бот для кадрового учёта и заявок на сервере: заявки (курсант, перевод, гос), переводы между отделами, увольнения, повышения, склад. Всё настраивается через `.env`.

## Что делает

**Заявки** — в канале кнопки «Курсант», «Перевод», «Гос. сотрудник». По нажатию открывается форма, заявка уходит в канал, сотрудники с нужной ролью принимают/отклоняют/редактируют. При принятии выдаются роли из конфига, меняется ник. Курсанту после принятия в ЛС уходит приказ и кнопка в канал экзамена.

**Переводы между отделами (ГРОМ, ППС, ОСБ, ОРЛС)** — в своих каналах кнопки «Подать заявку из [отдела]». Заявка согласуется: сначала источник (если не из Академии), потом целевой отдел. При одобрении снимаются роли отделов и рангов, выдаётся роль отдела и одна должность (стажёр/сотрудник). Из Академии в ППС — без кнопок; в остальные отделы — кнопка одобрения или отказ.

**Админ-перевод в ППС** — скрытый канал с кнопками ГРОМ/ОСБ/ОРЛС. Начальник вводит ID и причину, у участника снимаются роли отделов и рангов, выдаётся ППС и базовая должность. Запись об переводе пишется в канал из `CHANNEL_ADMIN_TRANSFER`.

**Увольнение** — канал с кнопкой «Подать заявление». В канал рапортов уходит оформленный embed: шапка «РАПОРТ НА УВОЛЬНЕНИЕ», в теле строка вида `ОТ [звание в родительном падеже] — @упоминание подавшего рапорт`, ФИО, причина и флаг «с/без возможности восстановления». Есть авто‑рапорт при выходе с сервера. Сотрудники с `FIRING_STAFF_ROLE_ID` одобряют или отклоняют: при одобрении снимаются роли (кроме перечисленных в `KEEP_ON_FIRE_*`), выдаётся роль уволенного, ник меняется на «Уволен | Имя Фамилия».

**Повышения** — рапорты приходят вебхуком (Google Form) или создаются вручную. В каналах повышений у сообщения кнопки «Одобрить» / «Отклонить». Сообщения «Подать рапорт» (селектор повышения + форма) создаются при старте бота (`PROMOTION_AUTO_SEND_ON_STARTUP=1` в .env) или командами `/promotion_setup_all`, `/orls_promotion_setup`, `/osb_promotion_setup`, `/grom_promotion_setup`, `/pps_promotion_setup` в нужном канале. Эти сообщения держатся внизу канала при новых сообщениях. При одобрении снимаются старые звания, выдаётся новая роль по маппингу. Аудит (принят/повышен/уволен) только в Google Form по `AUDIT_FORM_URL`.

**Склад** — канал заявок на выдачу. Сотрудники принимают/отклоняют/редактируют состав заявки: можно открыть корзину, поменять количество предметов или удалить позиции, с проверкой лимитов по предметам и категориям. При выдаче пишется запись в канал аудита склада. Есть кулдаун между заявками (`WAREHOUSE_COOLDOWN_HOURS`).

**Аудит** — события (принят, повышен, уволен) только в Google Form. В канал админ-перевода пишутся только админ-переводы.

## Как устроено

Роли staff задаются в `.env` (кто жмёт принять/отклонить по типам заявок). Роли начальников/замов — кто одобряет переводы и админ-перевод. При переводе всегда снимаются все роли отделов и все ранги, выдаётся только роль отдела и одна базовая должность. Вебхуки (например из Google Form) обрабатываются отдельно: по `WEBHOOK_ALLOWED_IDS` и `WEBHOOK_ALLOWED_CHANNEL_IDS`. После перезапуска бота кнопки под сообщениями восстанавливаются из БД. БД — SQLite по умолчанию (`DATABASE_URL`).

Для часто используемых каналов и ролей используется внутренний кэш (`ChannelCache` / `RoleCache` в `state`), чтобы минимизировать количество повторных `get_channel` / `get_role` и ускорить ответы на нажатия кнопок.

## Производительность

- **Один сервер, до ~5–10k человек.** Бот рассчитан на один основной сервер, шардирование не требуется.
- **Кэш каналов/ролей.** Все горячие места (склад, увольнения, заявки, диагностика, фоновые позиции) сначала читают канал/роль из кэша, и только если там пусто — из Discord‑клиента.
- **Интервалы фоновых задач.** Позиционные менеджеры (шапки каналов) используют разные `check_interval`: склад и старт‑канал проверяются чаще, шапки переводов/академии — реже, чтобы не спамить `history.fetch`.
- **Кэш сообщений Discord.** В `Config.BOT_MAX_MESSAGES` (и `.env` через `BOT_MAX_MESSAGES`) можно управлять размером внутреннего кэша сообщений клиента. По умолчанию стоит более низкое значение, чем в чистом discord.py, чтобы экономить память.
- **Интенты.** Через `ENABLE_MESSAGE_CONTENT_INTENT` в `.env` можно выключить `message_content`‑intent, если в проде используются только слэш‑команды и кнопки — это уменьшает поток событий от Discord.

## Запуск

**Требования:** Python 3.11 или новее (рекомендуется 3.11+).

Скопируй `.env.example` в `.env`, заполни токен, ID сервера, каналов и ролей. Перед первым запуском проверка окружения выведет список отсутствующих переменных при неверной конфигурации. Затем:

```bash
pip install -r requirements.txt
python main.py
```

Для фиксации версий зависимостей (рекомендуется в CI): `pip install -r requirements.txt -c constraints.txt`

В `.env` переменные разбиты по блокам с подписями.

## Логирование

Уровни: **DEBUG** — отладочные сообщения; **INFO** — старт/остановка и важные действия; **WARNING** — восстановимые проблемы; **ERROR** — ошибки с трейсбеком.

В `.env` задаются:
- `LOG_FILE` — путь к файлу лога (по умолчанию `bot.log`); ротация 2 MB, 5 файлов.
- `LOG_FORMAT` — формат строки лога.
- `LOG_LEVEL` — уровень (DEBUG, INFO, WARNING, ERROR).

Логи пишутся в файл и в stdout. Для интеграции с внешним лог-менеджером (Papertrail, LogDNA и т.п.) можно направить stdout или файл в их агент без изменения кода бота.

## Слэш-команды

Все перечисленные команды доступны только участникам с **ролью выше роли бота** на сервере.

| Команда | Описание |
|--------|----------|
| `/ping` | Задержка бота (мс). |
| `/diag` | Диагностика: состояние заявок, кэшей, БД. |
| `/diag_clean_orphans` | Удаление из БД записей, у которых сообщение в Discord уже удалено. |
| `/clear_firing` | Удаление старых заявок на увольнение (по умолчанию старше 7 дней). |
| `/orls_promotion_setup` | Создать в текущем канале сообщение «Подать рапорт» для ОРЛС. |
| `/osb_promotion_setup` | То же для ОСБ. |
| `/grom_promotion_setup` | То же для ГРОМ. |
| `/pps_promotion_setup` | То же для ППС. |
| `/promotion_setup_all` | Создать сообщения «Подать рапорт» во всех настроенных каналах повышения. |

## Роли (кто что обрабатывает)

Настраиваются в `.env`:

- **STAFF_ROLE_ID** — принимает/отклоняет заявки «Курсант» (кнопки в канале заявок).
- **TRANSFER_STAFF_ROLE_ID**, **GOV_STAFF_ROLE_ID** — заявки «Перевод» и «Гос. сотрудник».
- **FIRING_STAFF_ROLE_ID** — одобряет/отклоняет рапорты на увольнение.
- **FIRING_SENIOR_ROLE_ID** — кнопка «Уволить» (увольнение по ID без рапорта).
- **WAREHOUSE_STAFF_ROLE_ID** — заявки на склад (принять/отклонить/редактировать).
- **Роли начальников/замов (ROLE_CHIEF_*, ROLE_DEPUTY_*)** — одобрение заявок на перевод между отделами и админ-перевод.
- Каналы повышений (**PROMOTION_CH_***) задают, в каком канале какие роли кадровика обрабатывают рапорты на повышение.

## Пример минимального .env

```env
DISCORD_BOT_TOKEN=ваш_токен
GUILD_ID=123456789012345678
PROMOTION_CH_01=111:222
PROMOTION_CH_02=333:444
RANKMAP_01=рядовой -> младший сержант:555
START_CHANNEL_ID=666
REQUEST_CHANNEL_ID=777
STAFF_ROLE_ID=888
```

Полный перечень переменных — в `.env.example`.

## Структура БД (SQLite)

Таблицы по умолчанию в `data/bot.db` (или путь из `DB_PATH` / `DATABASE_URL`):

| Таблица | Назначение |
|--------|------------|
| `requests` | Заявки «Курсант», «Перевод», «Гос. сотрудник» (message_id, user_id, data, request_type). |
| `firing_requests` | Рапорты на увольнение. |
| `promotion_requests` | Рапорты на повышение. |
| `warehouse_requests` | Заявки на выдачу со склада. |
| `department_transfer_requests` | Заявки на перевод между отделами (approved_source, approved_target). |
| `orls_draft_reports`, `osb_draft_reports`, `grom_draft_reports`, `pps_draft_reports` | Черновики рапортов повышения по отделам. |

После рефакторинга состояния склада добавлены таблицы: `warehouse_sessions` (корзины), `warehouse_cooldowns` (кулдаун выдачи).

## Конечные автоматы заявок (FSM)

Переходы состояний заявок вынесены в отдельные модули в `services/`:

- **Перевод между отделами** — `services/department_transfer_fsm.py`: состояния `pending_source`, `pending_target`, `approved`; функции `get_state(payload)`, `can_approve_source`, `can_approve_target`, `apply_transition(payload, action, value)`.
- **Увольнение** — `services/firing_fsm.py`: состояния `pending` / `rejected`; `can_approve(payload)`.
- **Повышение** — `services/promotion_fsm.py`: аналогично увольнению.

View (department_approval_view, firing_view, promotion_view) перед обновлением БД проверяют допустимость перехода через эти модули.
