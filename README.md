# Discord-бот УВД

Бот для кадрового учёта и заявок на сервере (заявки курсант/перевод/гос, переводы между отделами, увольнения, повышения, склад). Все ID и настройки задаются в `.env`; в коде лишних описаний нет.

---

## Что умеет бот

**Заявки (канал с кнопками)**  
Пользователь нажимает «Курсант», «Перевод» или «Гос. сотрудник» и заполняет форму. Сообщение с заявкой появляется в канале; сотрудники с нужной ролью могут принять, отклонить или отправить на редактирование. При принятии выдаются роли из `.env` (CADET_ROLE_*, TRANSFER_ROLE_*, GOV_ROLE_TO_GIVE), меняется ник (префикс из конфига). Курсанту после принятия в ЛС уходит приказ и кнопка перехода в канал экзамена.

**Переводы между отделами (ГРОМ, ППС, ОСБ, ОРЛС)**  
В отдельных каналах — кнопки «Подать заявку из [отдела]». Заявка идёт на одобрение: сначала источник (если не из Академии), потом целевой отдел. При одобрении снимаются все роли отделов и рангов (все должности всех отделов), выдаётся роль целевого отдела и одна начальная должность (стажёр/сотрудник). Из Академии в ППС — автодобро без кнопок; в ГРОМ/ОРЛС/ОСБ — кнопка «Одобрение [отдела]» или «Отклонить».

**Административный перевод в ППС**  
Скрытый канал с кнопками ГРОМ, ОСБ, ОРЛС. Начальник/зам вводит ID сотрудника и причину. У участника снимаются все роли отделов и рангов, выдаются роль ППС и базовая должность ППС. Запись об админ-переводе уходит в канал из `CHANNEL_ADMIN_TRANSFER`.

**Увольнение**  
Канал с кнопкой «Подать заявление». Заявление уходит в канал рапортов; сотрудники с FIRING_STAFF_ROLE_ID одобряют или отклоняют. При одобрении снимаются роли (кроме перечисленных в KEEP_ON_FIRE_*), выдаётся роль уволенного, ник меняется на «Уволен | Имя Фамилия». В канал бот сообщение об увольнении не пишет; кадровый аудит только в Google Form.

**Повышения**  
Рапорты на повышение могут приходить вебхуком (Google Form) или создаваться вручную. В каналах повышений (PROMOTION_CH_*) у сообщения с рапортом есть кнопки «Одобрить повышение» и «Отклонить рапорт». При одобрении снимаются старые звания (по ALL_RANK_* и RANK_ROLE_MAPPING), выдаётся новая роль по RANKMAP_* (текст перехода → ID роли). При повышении до сержанта выдаётся роль «прошедший академию» (ROLE_PASSED_ACADEMY). Кадровый аудит (принят/повышен/уволен) отправляется только в Google Form по AUDIT_FORM_URL.

**Склад**  
Канал с кнопкой подачи заявки на выдачу предметов. Сотрудники принимают/отклоняют; при принятии запись уходит в канал аудита склада. Есть кулдаун между заявками (WAREHOUSE_COOLDOWN_HOURS).

**Кадровый аудит**  
Все события (принят, повышен, уволен) уходят только в Google Form (AUDIT_FORM_URL). В канал административного перевода пишутся только административные переводы (из модалки ГРОМ/ОСБ/ОРЛС → ППС).

---

## Механики

- **Роли staff** — кто может жать кнопки принять/отклонить в каждом типе заявок (STAFF_ROLE_ID, TRANSFER_STAFF_ROLE_ID, FIRING_STAFF_ROLE_ID, WAREHOUSE_STAFF_ROLE_ID).
- **Роли начальников/замов** — кто одобряет заявки на перевод и админ-перевод (ROLE_CHIEF_*, ROLE_DEPUTY_* по отделам).
- **Перевод** — всегда снимаются все роли отделов и все ранги (ГРОМ, ППС, ОСБ, ОРЛС, Академия); выдаётся только роль отдела и одна базовая должность (первая из ROLE_RANK_* отдела).
- **Вебхуки** — сообщения от вебхуков (например из Google Form) обрабатываются отдельно: рапорт увольнения/повышения парсится, бот создаёт своё сообщение с кнопками и удаляет исходное. Разрешать можно по WEBHOOK_ALLOWED_IDS и WEBHOOK_ALLOWED_CHANNEL_IDS (пусто = разрешены все).
- **Восстановление кнопок** — при перезапуске бота кнопки (view) под сообщениями заявок/рапортов восстанавливаются из БД (restore_views).
- **База данных** — SQLite по умолчанию (DATABASE_URL). В БД хранятся заявки, рапорты увольнения/повышения, заявки склада и переводов между отделами.

---

## Запуск

Скопируй `.env` и заполни токен, ID сервера, каналов и ролей. Затем:

```bash
pip install -r requirements.txt
python main.py
```

В `.env` все переменные разбиты по блокам с подписями — что за переменная и для чего.
