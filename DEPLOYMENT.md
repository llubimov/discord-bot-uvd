# Готовность бота к выкладке на сервер

## Краткий вердикт

**Бот готов к полноценной выкладке** при выполнении условий ниже. Критичных блокеров нет; есть рекомендации по безопасности и эксплуатации.

---

## Что уже в порядке

### Конфигурация и секреты
- Токен и все чувствительные данные берутся только из `.env` (через `python-dotenv`).
- В коде нет захардкоженных токенов или паролей.
- `.gitignore` исключает `.env` и `.env.*` — секреты не попадут в репозиторий при коммите.

### Запуск и отказоустойчивость
- При старте: инициализация БД, синхронизация slash-команд, восстановление View из БД, проверки каналов/ролей, фоновые задачи.
- Логирование: ротация файла логов (2 MB × 5 файлов), вывод в консоль, уровень из `LOG_LEVEL`.
- БД: SQLite с WAL, автосоздание директории для `DB_PATH`/`DATABASE_URL`, очистка старых записей по расписанию.
- Защита от двойных нажатий: `action_lock` по `message_id` для одобрения/отклонения заявок и рапортов.
- Rate limit Discord API: повторные попытки при 429 с экспоненциальной задержкой в `utils/rate_limiter.py`.

### Функциональность
- Восстановление кнопок после перезапуска (заявки, увольнения, повышения, склад, переводы между отделами).
- Очистка «осиротевших» записей в БД при старте (`cleanup_orphan_records`) и команда `/diag_clean_orphans`.
- Диагностика: `/diag`, проверки каналов/ролей/прав при запуске (`startup_checks`, `health_report`).
- Обязательные параметры: при отсутствии `DISCORD_BOT_TOKEN`, `PROMOTION_CHANNELS`, `RANK_ROLE_MAPPING` бот падает при старте с понятной ошибкой.

### Зависимости
- `requirements.txt` с зафиксированными версиями (discord.py, aiohttp, python-dotenv и т.д.).

---

## Что обязательно перед выкладкой

1. **Не коммитить `.env`**  
   Убедиться, что `.env` не добавлен в git. Если он когда-либо попадал в историю — сменить токен бота в Discord Developer Portal и не использовать старый.

2. **Роль бота на сервере**  
   Роль бота должна быть ниже ролей, которым нужно выдавать/снимать роли (иначе startup_checks предупредит в логах). Slash-команды (`/diag`, `/ping` и т.д.) доступны только пользователям с ролью выше роли бота.

3. **Минимальный набор переменных в `.env`**  
   Обязательны: `DISCORD_BOT_TOKEN`, `GUILD_ID`, `PROMOTION_CHANNELS` (или `PROMOTION_CH_*`), `RANK_ROLE_MAPPING` (или `RANKMAP_*`). Остальные — по используемым функциям (каналы заявок, роли staff, отделы и т.д.). Можно ориентироваться на `.env.example`.

---

## Рекомендации для продакшена

| Область | Рекомендация |
|--------|---------------|
| **Процесс** | Запускать через процесс-менеджер (systemd, supervisord, PM2 для node-обёртки) или контейнер с рестартом при падении. |
| **Логи** | Хранить `LOG_FILE` вне репозитория (например, `/var/log/uvd-bot/bot.log`). Ротация уже настроена в коде. |
| **БД** | Для одной гильдии SQLite достаточно. Путь к БД задавать через `DB_PATH` или `DATABASE_URL` (например, в отдельной директории с бэкапами). |
| **Контейнер** | При желании добавить `Dockerfile` (multi-stage: установка зависимостей → копирование кода → `python main.py`) и не хранить `.env` в образе — передавать через секреты/volume. |
| **Шаблон конфига** | В репозитории есть `.env.example` (без значений секретов) — копировать в `.env` и заполнить на сервере. |

---

## Чего нет (не блокирует выкладку)

- Нет Dockerfile — можно запускать как обычный Python-процесс или добавить образ позже.
- Нет `.env.example` в репо — добавлен отдельно; перед первым деплоем скопировать в `.env` и заполнить.
- Нет отдельного health-check HTTP-эндпоинта — «живость» бота видна по логам и работе в Discord.
- База по умолчанию SQLite — для одной гильдии этого достаточно; при росте можно вынести в PostgreSQL и доработать `database.py`.

---

## Быстрый чек-лист перед запуском на сервере

- [ ] Файл `.env` создан и заполнен (токен, GUILD_ID, каналы, роли); не коммитится в git.
- [ ] Установлены зависимости: `pip install -r requirements.txt`.
- [ ] Роль бота на сервере ниже ролей, которые бот выдаёт/снимает.
- [ ] При первом запуске проверены логи: «БОТ ГОТОВ К РАБОТЕ», нет ошибок в блоке «ПРОВЕРКА ПРИ ЗАПУСКЕ».
- [ ] При необходимости настроен автозапуск и рестарт процесса (systemd/supervisor и т.п.).
